{% extends "base.html" %}

{% block head %}
<style>
  #title-enikki {
    color: white !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    z-index: 10;
  }

  .wrapper::-webkit-scrollbar {
    display: none;
  }

  .wrapper {
    height: 100dvh;

    overflow-anchor: none;
    overflow-x: hidden;
    overflow-y: scroll;

    scroll-snap-type: y mandatory;
    scroll-snap-stop: normal;
    scroll-behavior: auto;
  }

  #view-list {
    position: relative;
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    margin: 0;
    padding: 0;
  }

  .view {
    height: 100dvh;
    scroll-snap-align: start;
    scroll-snap-stop: normal;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 32px;
    width: 100%;
    padding: 0 20px;
    box-sizing: border-box;
  }

  .enikki-wrapper {
    grid-column: 2;
    margin-bottom: 20px;
  }

  .name-section {
    width: 100%;
    color: white;
  }

  .name-label {
    font-size: 1.5rem;
  }

  .name-display {
    margin-inline-start: 50px;
    font-size: 2.5rem;
  }

  .button-container {
    grid-column: 3;
    justify-self: start;
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: auto;
    margin-bottom: 10dvh;
  }

  .circle-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background-color: white;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .circle-btn:hover {
    background-color: #ddd;
  }

  .circle-btn.marked {
    filter: saturate(0%);
  }

  .f-icon {
    width: 115%;
    margin-left: -3.5px;
  }

  img {
    width: 80%;
  }

  .comment-input {
    position: fixed;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 500px;
    padding: 10px;
    font-size: 18px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: white;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.1s ease-in-out;
    z-index: 1000;
  }

  .comment-input.show {
    opacity: 1;
    pointer-events: auto;
  }

  @media screen and (max-width: 768px) {
    li.view {
      grid-template-columns: 1fr;
      gap: 20px;
      align-content: center;
    }

    .enikki-wrapper {
      grid-column: 1;
      justify-self: center;
      align-self: center;
      margin-bottom: 0;
    }

    .name-section {
      display: flex;
      justify-content: center;
      align-items: baseline;
      gap: 20px;
    }

    .name-display {
      margin-inline-start: 0;
    }

    .button-container {
      grid-column: 1;
      flex-direction: row-reverse;
      justify-content: center;
      gap: 20px;
      margin: 0;
      margin-left: auto;
      margin-right: auto;
    }

    .circle-btn {
      width: 50px;
      height: 50px;
    }

    .comment-input {
      bottom: 80px;
    }
  }
</style>
<link href="/static/css/enikki.css" rel="stylesheet">
{% endblock head %}

{% block body %}


<div class="wrapper" id="scroll-container">
  <div id="view-list">
    {% for view in views %}
    <li class="view" id="post-{{ view.post.id }}">
      <div class="enikki-wrapper">
        <header class="name-section font-zenmaru">
          <span class="name-label">なまえ</span>
          <span class="name-display">{{ view.author_name }}</span>
        </header>
        {% with month=view.post.created_at.month, day=view.post.created_at.day, content=view.post.content,
        image_id=view.post.id %}
        {% include 'enikki.html' %}
        {% endwith %}
      </div>
      <div class="button-container">
        <button class="circle-btn favorite-btn {% if view.is_favorite %}marked{% endif %}"
          data-post-id="{{ view.post.id }}">
          <img src="/static/icons/F.png" class="f-icon" alt="花丸アイコン">
        </button>

        <button class="circle-btn comment-btn" data-post-id="{{ view.post.id }}">
          <img src="/static/icons/comments.png">
        </button>

        <button class="circle-btn report-btn" data-post-id="{{ view.post.id }}">
          <img src="/static/icons/three-dots.png" alt="三点リーダー">
        </button>
      </div>
      <input type="text" class="comment-input" data-post-id="{{ view.post.id }}" placeholder="コメントを入力 (Enterで送信)"
        value="{{ view.comment or '' }}" maxlength="20">
    </li>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('scroll-container');
    let isDown = false;
    let startY;
    let scrollTop;
    let isScrolling = false; // スクロールアニメーション中かどうかのフラグ
    let postCount = document.querySelectorAll('.view').length;

    let shouldReload = false;

    function getCurrentItemIndex() {
      return Math.round(container.scrollTop / window.innerHeight);
    }

    const socket = io();
    socket.on('new_post', function () {
      const currentItemIndex = getCurrentItemIndex();
      if (currentItemIndex === 0) {
        location.reload();
      } else {
        shouldReload = true; // スクロール中はリロードしない
      }
    });

    container.addEventListener('scrollsnapchange', () => {
      const currentItemIndex = getCurrentItemIndex();
      if (shouldReload && currentItemIndex === 0) {
        // スクロールが最初のアイテムに戻ったときにリロード
        location.reload();
      }
    });

    // --- 以下、ボタン操作などのJS（変更なし） ---
    const viewList = document.getElementById('view-list');
    viewList.addEventListener('click', (e) => {
      const favoriteBtn = e.target.closest('.favorite-btn');
      const commentBtn = e.target.closest('.comment-btn');
      if (favoriteBtn) toggleFavorite(favoriteBtn);
      if (commentBtn) toggleCommentInput(commentBtn);
    });

    viewList.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.classList.contains('comment-input')) {
        submitComment(e.target);
      }
    });

    function toggleFavorite(button) {
      const postId = button.dataset.postId;
      fetch(`/view/post/${postId}/favorite`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            button.classList.toggle('marked', data.is_favorite);
          }
        })
        .catch(err => console.error('Favorite toggle failed:', err));
    }

    function toggleCommentInput(button) {
      const postId = button.dataset.postId;
      const targetInput = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
      const isCurrentlyShown = targetInput.classList.contains('show');

      document.querySelectorAll('.comment-input').forEach(input => {
        input.classList.remove('show');
      });

      if (!isCurrentlyShown) {
        targetInput.classList.add('show');
        targetInput.focus();
      }
    }

    function submitComment(input) {
      const postId = input.dataset.postId;
      const content = input.value.trim();

      fetch(`/view/post/${postId}/comment`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content: content}),
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            console.log(`Comment ${data.action}:`, content);
            input.classList.remove('show');
          } else {
            alert('コメントの処理に失敗しました。');
          }
        })
        .catch(err => console.error('Comment submission failed:', err));
    }
  });
</script>
{% endblock body %}
