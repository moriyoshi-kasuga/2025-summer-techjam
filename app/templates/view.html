{% extends "base.html" %}

{% block head %}
<style>
  .button-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: auto;
    margin-bottom: 10px;
  }

  .circle-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background-color: white;
    color: #444;
    font-size: 20px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .circle-btn.marked {
    filter: saturate(0%);
  }

  img {
    width: 80%;
  }

  .f-icon {
    width: 115%;
    margin-left: -3.5px;
  }

  .circle-btn:hover {
    background-color: #ddd;
  }

  .comment-input {
    position: fixed;
    bottom: 50px;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 500px;
    padding: 10px;
    font-size: 18px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background-color: white;
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.1s ease-in-out;
    z-index: 1000;
  }

  .comment-input.show {
    opacity: 1;
    pointer-events: auto;
  }

  .wrapper {
    height: 100dvh;
    overflow-y: auto;
  }

  ul.view {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    /* 中央揃え */
    margin: 0;
    padding-inline-start: 0px;
    margin-bottom: 100px;
  }

  li.view {
    margin-top: 60px;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: start;
    gap: 32px;
    width: 100%;
    justify-items: center;
  }

  .enikki-wrapper {
    grid-column: 2;
  }

  .button-container {
    grid-column: 3;
    justify-self: start;
  }
</style>
<link href="/static/css/enikki.css" rel="stylesheet">
{% endblock head %}

{% block body %}
{% include "title-enikki.html" %}

<div class="big-wrapper">
  <div class="wrapper">
    <ul class="view" id="view-list">
      {% for view in views %}
      <li class="view" id="post-{{ view.post.id }}">
        <div class="enikki-wrapper">
          {% with month=view.post.created_at.month, day=view.post.created_at.day, content=view.post.content,
          image_id=view.post.id %}
          {% include 'enikki.html' %}
          {% endwith %}
        </div>
        <div class="button-container">
          <button class="circle-btn favorite-btn {% if view.is_favorite %}marked{% endif %}"
            data-post-id="{{ view.post.id }}">
            <img src="/static/icons/F.png" class="f-icon" alt="花丸アイコン">
          </button>

          <button class="circle-btn comment-btn" data-post-id="{{ view.post.id }}">
            <img src="/static/icons/comments.png">
          </button>

          <button class="circle-btn report-btn" data-post-id="{{ view.post.id }}">
            <img src="/static/icons/three-dots.png" alt="三点リーダー">
          </button>
        </div>
        <input type="text" class="comment-input" data-post-id="{{ view.post.id }}" placeholder="コメントを入力 (Enterで送信)"
          value="{{ view.comment or '' }}" maxlength="20">
      </li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const viewList = document.getElementById('view-list');

    viewList.addEventListener('click', (e) => {
      const favoriteBtn = e.target.closest('.favorite-btn');
      const commentBtn = e.target.closest('.comment-btn');

      if (favoriteBtn) {
        toggleFavorite(favoriteBtn);
      }

      if (commentBtn) {
        toggleCommentInput(commentBtn);
      }
    });

    viewList.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.classList.contains('comment-input')) {
        submitComment(e.target);
      }
    });

    function toggleFavorite(button) {
      const postId = button.dataset.postId;
      fetch(`/view/post/${postId}/favorite`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            button.classList.toggle('marked', data.is_favorite);
          }
        })
        .catch(err => console.error('Favorite toggle failed:', err));
    }

    function toggleCommentInput(button) {
      const postId = button.dataset.postId;
      const targetInput = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
      const isCurrentlyShown = targetInput.classList.contains('show');

      document.querySelectorAll('.comment-input').forEach(input => {
        input.classList.remove('show');
      });

      if (!isCurrentlyShown) {
        targetInput.classList.add('show');
        targetInput.focus();
      }
    }

    function submitComment(input) {
      const postId = input.dataset.postId;
      const content = input.value.trim();

      fetch(`/view/post/${postId}/comment`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({content: content}),
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            console.log(`Comment ${data.action}:`, content);
            input.classList.remove('show');
          } else {
            alert('コメントの処理に失敗しました。');
          }
        })
        .catch(err => console.error('Comment submission failed:', err));
    }
  });
</script>
{% endblock body %}
